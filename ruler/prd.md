# **项目需求文档：StarryLink - 新生代粉丝互动社区**

## **版本：3.0**
## **日期：2021年3月25日**

---

### **1. 项目概述 (Project Overview)**

#### **1.1 项目简介**
yoto是一款专为新生代追星和兴趣社群打造的iOS互动管理平台。它融合了即时通讯、社区管理和粉丝经济的特点，旨在为用户提供一个自由、私密、富有沉浸感的交流空间。 用户可以创建专属的“星球”（服务器），在其中设立不同主题的“星轨”（频道），并通过精细化的“引力”（角色权限）系统进行管理。平台致力于让每个粉丝群体都能轻松构建属于自己的线上家园，让追星和兴趣交流更加纯粹和深入。

#### **1.2 核心用户群体**
*   **Z世代粉丝群体:** 偶像明星、动漫、游戏、乐队、KOL等的粉丝。
*   **兴趣小组爱好者:** 对特定话题（如美妆、手办、潮玩、电竞等）有浓厚兴趣并寻求同好的年轻人。
*   **社群组织者和管理者:** 需要高效、自定义工具来管理线上社群的KOL、站姐/站哥、字幕组等。

#### **1.3 平台标签**
社交网络、兴趣社区、粉丝经济、新生代社交、粉丝社区、群聊、新生代社群、粉丝管理、视频群聊。

---

### **2. 技术栈 (Technology Stack)**

*   **后端开发语言:** Python
*   **后端框架:** **Flask** (轻量、灵活，采用`Application Factory`模式，搭配蓝图进行模块化开发)。
*   **数据库:** **MySQL 8.0+** (成熟稳定，社区支持广泛，适合关系型数据存储)。
*   **实时通讯:** **WebSocket** (实现低延迟、双向的实时消息和信令交换，可使用`Flask-Sockets`或`Uvicorn`+`Starlette`的WebSocket支持)。
*   **消息队列:** **Celery** (与Flask集成，用于处理异步任务、耗时操作)。
*   **多级缓存策略:**
    *   **L1 本地缓存:** **`cachetools`** (Python本地缓存库，实现TTL、LRU等策略，作为应用内高速缓存)。
    *   **L2 分布式缓存 / MQ Broker:** **Redis** (用于缓存跨服务共享的数据、会话管理，并作为Celery的消息中间件)。
*   **搜索引擎:** **Elasticsearch** (用于实现高效的内容、用户、星球的全局搜索)。
*   **部署:** **Docker**容器化部署，通过`Gunicorn` + `Nginx`进行服务托管。

---

### **3. 功能需求 (Functional Requirements)**

#### **3.1 核心架构：星球、星轨、引力系统**
*   **星球 (Server):**
    *   用户可创建星球，并生成唯一的、可自定义的邀请链接。
    *   星球所有者（球长）拥有最高管理权限。
    *   可设置星球为公开或私密。私密星球需通过邀请链接或审核加入。
    *   可自定义星球头像、名称、描述和欢迎界面。

*   **星轨 (Channel):**
    *   管理员可在星球内创建不同类型的星轨：
        *   **文本星轨:** 用于文字、图片、表情、文件分享。支持Markdown。
        *   **语音星轨:** 用于多人实时语音群聊。
        *   **视频星轨:** 支持多人视频群聊及屏幕共享。
        *   **公告星轨:** 仅管理员可发言。
    *   星轨可被归类到“星系”（Category）下，方便组织管理。

*   **引力 (Role & Permission):**
    *   精细化的角色权限系统。
    *   可创建多种自定义角色（如：管理员、核心粉、禁言用户）。
    *   为每个角色精确分配不同星轨的权限，包括：查看、发言、提及、管理等。
    *   用户的最终权限由其拥有的所有角色权限叠加计算。

#### **3.2 用户与身份系统**
*   **注册与登录:** 支持手机号、邮箱注册，并鼓励绑定第三方社交账号（微信、微博）以便邀请好友。
*   **个人资料:**
    *   自定义头像、昵称、个人简介。
    *   “身份标签”系统：用户可以为自己添加兴趣标签（如：xx的粉丝、xx CP粉、视频剪辑师等），方便找到同好。
    *   展示所在的星球列表。
*   **好友系统:**
    *   用户可以添加好友，进行一对一的私聊（文本、语音、图片）。
    *   可以查看好友的在线状态。

#### **3.3 消息与互动**
*   **实时消息:** 基于WebSocket实现所有群聊和私聊的实时消息传递。
*   **丰富互动:**
    *   **@提及 (Mention):** @特定用户或角色组，被@者收到强提醒。
    *   **回复 (Reply):** 引用回复特定消息。
    *   **表情回应 (Reaction):** 用Emoji对消息快速反应。
    *   **消息置顶 (Pin):** 管理员置顶重要消息。
    *   **话题 (Thread):** 基于消息开启临时子讨论区。

#### **3.4 粉丝社区与内容生态**
*   **视频群聊增强功能:**
    *   **屏幕共享:** 方便组织者分享内容，如一起观看视频、分析物料等。
    *   **虚拟背景:** 增加趣味性和隐私保护。
*   **内容发现:**
    *   **星球广场:** 一个公共的星球发现页面，展示优秀的公开星球，帮助用户发现新社群。
    *   **全局搜索:** 用户可以通过关键词搜索公开的星轨内容、用户和星球。
*   **粉丝管理与经济:**
    *   **打卡/签到系统:** 提升用户粘性和活跃度，可与角色等级挂钩。
    *   **专属身份卡/徽章:** 管理员可以为做出贡献或参与特定活动的用户发放独特的数字徽章，展示在个人资料页。
    *   **虚拟礼物/应援:** 用户可以在群聊中给喜欢的发言者或KOL赠送虚拟礼物（未来可拓展为付费功能）。

#### **3.5 管理与安全**
*   **内容审核与风控:**
    *   集成智能内容审核系统，自动识别和过滤涉黄、涉政、广告等违规内容。
    *   提供关键词过滤功能，允许管理员自定义屏蔽词。
    *   提供用户举报功能，管理员可以快速处理违规用户和内容。
*   **用户管理:**
    *   管理员可以对用户进行禁言、踢出星球、封禁账号等操作。
    *   操作日志：记录所有管理员的管理行为，方便追溯。
*   **安全与隐私:**
    *   提供详细的隐私设置，允许用户控制谁可以看到自己的个人信息和在线状态。
    *   端到端加密（E2EE）可作为未来高安全需求私聊的增强功能。
    *   防止恶意机器人和垃圾信息的机制。
---

### **4. 消息队列模块设计 (Message Queue Module Design)**

引入消息队列是本系统架构的核心，用于实现**异步化、解耦、削峰**。

#### **4.1 架构**
*   **框架:** `Celery`
*   **消息中间件 (Broker):** `Redis`

#### **4.2 多队列与Worker设计**
为实现任务优先级和资源隔离，采用多队列、多Worker架构。

*   **队列定义:**
    *   `q_notifications` (高优先级): 处理@提及、私信等实时性强的推送通知。
    *   `q_default` (中优先级): 处理常规异步任务，如发送欢迎邮件、更新用户统计。
    *   `q_media` (IO密集型): 处理耗时的媒体文件操作，如图片压缩、视频转码、内容审核。
    *   `q_batch` (CPU密集型): 处理批量数据运算和定时任务，如生成日报表。

*   **Worker配置建议:**
    *   **Notification Workers:** 专门消费 `q_notifications`，高并发配置。
    *   **Default Workers:** 消费 `q_default`，中等并发配置。
    *   **Media/Batch Workers:** 消费 `q_media` 和 `q_batch`，低并发配置，避免过度消耗服务器资源。

#### **4.3 核心异步任务定义**

1.  **通知推送 (`tasks.notification_tasks`):**
    *   **任务:** `send_push_notification(user_ids, title, body)`
    *   **触发:** @提及、私信、公告。
    *   **逻辑:** 异步调用APNs/FCM等推送服务。
    *   **路由至:** `q_notifications`

2.  **媒体处理 (`tasks.media_tasks`):**
    *   **任务:** `process_uploaded_image(image_id)`
    *   **触发:** 用户上传图片。
    *   **逻辑:** API仅保存原图并立刻返回，此任务异步执行缩略图生成、压缩、内容安全审核，最后更新数据库状态。
    *   **路由至:** `q_media`

3.  **社区管理 (`tasks.community_tasks`):**
    *   **任务:** `on_user_join_server(user_id, server_id)`、`generate_daily_report()` (定时任务)
    *   **触发:** 用户加入星球、Celery Beat定时调度。
    *   **逻辑:** 发送欢迎消息、更新统计数据、生成报表等。
    *   **路由至:** `q_default`, `q_batch`

---

### **5. 非功能性需求 (Non-Functional Requirements)**

#### **3.1 性能 (Performance)**
*   消息平均延迟 < 200ms。
*   应用冷启动时间 < 2s。
*   支持单星球万人同时在线，单星轨千人级别消息并发。

#### **3.2 可用性 (Usability)**
*   **UI/UX设计:** 遵循iOS设计规范，界面简洁美观，符合Z世代审美。 可采用暗黑模式和自定义主题色。
*   **交互流畅:** 动画效果自然，操作反馈及时。
*   **新用户引导:** 提供清晰的新手教程，帮助用户快速了解星球、星轨、角色的核心概念。

#### **3.3 可扩展性 (Scalability)**
*   后端服务采用微服务架构，便于未来对单一功能（如音视频、消息）进行独立扩展。
*   数据库支持读写分离和分库分表，以应对未来的用户和数据增长。

#### **3.4 安全性 (Security)**
*   对用户密码等敏感信息进行加密存储。
*   所有API通信使用HTTPS。
*   防止SQL注入、XSS、CSRF等常见Web攻击。
*   定期进行安全审计和漏洞扫描。

---

### **6. 给Cursor的开发提示 (Prompts for AI-Assisted Development)**

#### **阶段一：项目初始化**
> "请为我创建一个基于Python Flask框架的社交应用后端项目，命名为`starrylink_backend`。使用`Application Factory`模式，并配置好与MySQL的连接。请创建以下蓝图: `users`, `servers`, `channels`, `roles`, `auth`。同时，请集成`Flask-SQLAlchemy`, `Flask-Migrate`, `Flask-JWT-Extended` 和 `Celery`，并生成推荐的项目目录结构和基础的`config.py`文件。"

#### **阶段二：模型与API实现**
> "请在`servers`蓝图下的`models.py`中，使用SQLAlchemy定义`Server`和`ServerMember`模型。`Server`模型包含`name`, `owner_id`等字段；`ServerMember`作为中间表，处理用户和星球的多对多关系，并包含`role_id`字段。然后，在`views.py`中，创建一个API路由`/servers`，实现创建星球(POST)和获取用户加入的星球列表(GET)的逻辑，并使用JWT进行保护。"

#### **阶段三：复杂功能实现（缓存与异步任务）**
> "我想为‘获取星球详情’的API实现多级缓存。请帮我实现一个函数，它首先检查`cachetools`本地缓存，若未命中则检查`Redis`，若仍未命中则查询MySQL数据库，并将结果写回两级缓存。然后，请为用户上传图片的API集成异步任务：视图函数接收图片后，异步调用`tasks.media_tasks.process_uploaded_image`任务，并确保该任务被路由到名为`q_media`的Celery队列中。"

#### **阶段四：测试与优化**
> "请为`roles`蓝图中的权限检查逻辑编写单元测试。需要覆盖以下场景：1. 用户拥有正确的角色，可以访问某个频道。2. 用户没有相应角色，访问频道被拒绝。3. 管理员可以修改他人的角色。请使用Pytest框架。"
